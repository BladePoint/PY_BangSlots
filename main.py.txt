import pygame
import api.orifice as orifice
import json
import textwrap
import logging
import os
import sys
from datetime import datetime

from title_screen import TitleScreen

logging.basicConfig( # Configure logging
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[logging.StreamHandler(stream=sys.stdout)],
    force=True
)
logger = logging.getLogger('orifice.app') # Get application logger
logger.info("Application starting")

try: # Load game info from JSON
    logger.debug("Loading game info from JSON")
    with open('gameinfo.json', 'r') as f:
        game_info = json.load(f)
    logger.info(f"Loaded game: {game_info['title']} v{game_info['version']}")
except Exception as e:
    logger.error(f"Failed to load game info: {e}")
    game_info = {
        "title": "Depth Explorer",
        "description": "A visualization demo for Orifice hardware.",
        "version": "1.0.0"
    }
    logger.warning("Using default game info")

try: # Initialize Orifice device
    logger.info("Initializing Orifice device")
    device = orifice.Orifice()
except Exception as e:
    logger.critical(f"Failed to initialize device: {e}")
    pygame.quit()
    sys.exit(1)

try: # Initialize Pygame Display
    logger.info("Initializing Pygame")
    SCREEN_WIDTH, SCREEN_HEIGHT = 800, 480
    pygame.init()
    screen = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT), pygame.HWSURFACE | pygame.DOUBLEBUF)
    pygame.display.set_caption(game_info["title"])
    logger.debug("Pygame display initialized")
except Exception as e:
    logger.critical(f"Failed to initialize display: {e}")
    device.close()
    sys.exit(1)

try: # Initialize fonts
    title_font = pygame.font.SysFont(None, 64)
    font = pygame.font.SysFont(None, 36)
    small_font = pygame.font.SysFont(None, 24)
    logger.debug("Fonts loaded")
except Exception as e:
    logger.error(f"Error loading fonts: {e}")
    title_font = font = small_font = pygame.font.SysFont(None, 24)  # Fallback


logger.info("Creating screen instances...")
title_screen = TitleScreen(screen)
active_screen = title_screen
active_screen.on_enter()

clock = pygame.time.Clock() # Clock
running = True
last_depth = -1  # Force first render
fps_update_time = 0
frame_count = 0
fps_display = "FPS: --"

logger.info("Entering main loop")
try: # Main Loop
    while running:
        time_delta = clock.tick(60) / 1000.0
        current_signal = None
        for event in pygame.event.get(): # Event handling
            if event.type == pygame.QUIT:
                logger.info("Quit event received")
                running = False
            if active_screen:
                signal = active_screen.handle_event(event)
                if signal: # If a signal like "START_GAME" is returned
                    current_signal = signal

        try: # Get current depth
            current_depth = device.depth
        except Exception as e:
            logger.error(f"Error getting depth: {e}")
            current_depth = last_depth if last_depth >= 0 else 0
            
        if active_screen:
            active_screen.update(time_delta)

        if current_signal == "START_GAME":
            logger.info("Received START_GAME signal from title screen.")
            # Here you would switch:
            # active_screen.on_exit()
            # active_screen = your_next_screen_handler_instance
            # active_screen.on_enter()
            # For now, you could just set running = False to test
            # running = False

        if active_screen: # Rendering
            active_screen.render()
        else:
            screen.fill((50,0,50)) # Dark purple error/fallback if no active screen

        # Calculate FPS every second
        frame_count += 1
        current_time = pygame.time.get_ticks()
        if current_time - fps_update_time > 1000:
            fps = frame_count
            fps_display = f"FPS: {fps}"
            logger.info(f"FPS: {fps}")
            frame_count = 0
            fps_update_time = current_time
        fps_text = small_font.render(fps_display, True, (0, 255, 0))
        screen.blit(fps_text, (10, 10)) # Blit at (10, 10)

        pygame.display.flip()
except Exception as e:
    logger.critical(f"Unhandled exception in main loop: {e}", exc_info=True)
    
finally: # Clean up
    logger.info("Shutting down application")
    try:
        device.close()
        logger.debug("Device closed")
    except Exception as e:
        logger.error(f"Error closing device: {e}")
    try:
        pygame.quit()
        logger.debug("Pygame resources released")
    except Exception as e:
        logger.error(f"Error quitting pygame: {e}")
        
    logger.info("Application terminated")